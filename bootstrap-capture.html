<video autoplay></video>
<canvas style="display:none;"></canvas>

<script>
  var video = document.querySelector('video');
  var canvas = document.querySelector('canvas');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;

  function processResults(arr) {
    var noPadding = arr.filter(function(a) {
      return a != 2
    });
    console.log(arr.join(''));
    if ((noPadding % 8) != 0) {
      console.log("not enough data")
    } else {
      return fromBinaryString(arr.join(''));
    }
  }

  function fromBinaryString(str) {
    var res = '',
      j;
    for (var i = 0; i < str.length; i = j) {
      j += 8;
      res += String.fromCharCode(parseInt(str.slice(i, j), 2));
    }
    return res;
  }

  function snapshot() {
    if (localMediaStream) {
      ctx.drawImage(video, 0, 0);
      var data = ctx.getImageData(100, 100, 1, 1).data;
      if ((data[0] > data[1]) && (data[0] > data[2]) && (data[0] > 240))
        return 0;
      if ((data[1] > data[0]) && (data[1] > data[2]) && data[1] > 180)
        return 1;
      if ((data[2] > data[0]) && (data[2] > data[1]) && data[2] > 180)
        return 2;
      else
        return 2;
    }
  }

  var resultArray = [];
  var push = function(data) {
    if (resultArray.slice(-1)[0] != data) {
      console.log(data);
      resultArray.push(data);
    }
  }

  var receiveToken = undefined;

  document.addEventListener('click', function() {
    if (receiveToken != undefined) {
      clearInterval(receiveToken);
      receiveToken = undefined;
      processResults(resultArray);
    } else {
      receiveToken = setInterval(function() {
        push(snapshot())
      }, 100);
    }
  });

  navigator.webkitGetUserMedia({
    video: true
  }, function(stream) {
    video.src = window.URL.createObjectURL(stream);
    localMediaStream = stream;
  }, function(e) {
    console.log("error: " + e)
  });
</script>
